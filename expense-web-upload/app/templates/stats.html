<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>小账本 - 统计</title>
  <style>
    :root{
      --bg1:#f6f7fb; --bg2:#f3f7ff;
      --card:#ffffff; --text:#111827; --muted:#6b7280;
      --line:#e5e7eb; --primary:#2563eb; --primary2:#1d4ed8;
      --shadow:0 12px 28px rgba(17,24,39,.08); --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"PingFang SC","Microsoft YaHei",Arial,sans-serif;
      color:var(--text);
      background: linear-gradient(180deg, var(--bg2), var(--bg1));
      position:relative;
      overflow-x:hidden;
    }
    /* soft background blobs (no external images) */
    body::before, body::after{
      content:"";
      position:absolute;
      width:520px;height:520px;border-radius:50%;
      filter: blur(30px);
      opacity:.35;
      z-index:0;
    }
    body::before{
      top:-220px; left:-180px;
      background: radial-gradient(circle at 30% 30%, rgba(37,99,235,.45), rgba(37,99,235,0) 60%);
    }
    body::after{
      bottom:-260px; right:-220px;
      background: radial-gradient(circle at 30% 30%, rgba(16,185,129,.35), rgba(16,185,129,0) 60%);
    }

    .container{max-width:980px;margin:24px auto;padding:0 16px;position:relative;z-index:1;}

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;background:rgba(255,255,255,.92);
      border:1px solid rgba(229,231,235,.9);
      border-radius:20px;box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:10px;}
    .brand-name{font-weight:900;letter-spacing:.3px;}
    .brand-sub{font-size:12px;color:var(--muted);margin-top:2px;}
    .actions{display:flex;gap:10px;align-items:center;}
    .btn{
      padding:10px 14px;border-radius:12px;border:1px solid rgba(37,99,235,.35);
      background:#fff;color:var(--primary2);font-weight:800;cursor:pointer;
    }
    .btn:hover{border-color:var(--primary2);}
    .btn-primary{background:var(--primary);border-color:var(--primary);color:#fff;}
    .btn-primary:hover{background:var(--primary2);border-color:var(--primary2);}

    .card{
      background:rgba(255,255,255,.92);
      border:1px solid rgba(229,231,235,.9);
      border-radius:20px;
      box-shadow:var(--shadow);
      padding:16px;
      margin-top:14px;
      backdrop-filter: blur(10px);
    }

    .muted{color:var(--muted);font-size:13px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end;}

    select{
      padding:10px 12px;border:1px solid var(--line);border-radius:12px;outline:none;background:#fff;font-size:14px;
      min-width:120px;
    }
    select:focus{border-color:rgba(37,99,235,.6);box-shadow:0 0 0 4px rgba(37,99,235,.12);}

    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px;}
    @media (max-width:520px){.stats{grid-template-columns:1fr;}}
    .stat{border:1px solid var(--line);border-radius:16px;padding:12px;background:rgba(249,250,251,.9);}
    .stat .k{color:var(--muted);font-size:12px;}
    .stat .v{font-size:18px;margin-top:6px;font-weight:900;}

    table{width:100%;border-collapse:collapse;border-radius:16px;overflow:hidden;border:1px solid var(--line);background:#fff;margin-top:12px;}
    th,td{padding:10px;border-bottom:1px solid var(--line);font-size:14px;vertical-align:top;}
    th{background:#f9fafb;color:#374151;font-weight:900;font-size:13px;text-align:left;}
    tr:last-child td{border-bottom:none;}

    .rowbtn{padding:8px 10px;border-radius:10px;border:1px solid rgba(37,99,235,.25);background:#fff;color:var(--primary2);cursor:pointer;font-weight:800;}
    .rowbtn:hover{border-color:var(--primary2);}

    .section-title{margin:14px 0 6px;font-weight:900;}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#f9fafb;font-size:12px;color:#374151;font-weight:800;}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <!-- logo -->
        <svg width="34" height="34" viewBox="0 0 64 64" fill="none" aria-hidden="true">
          <path d="M12 18c0-3.3 2.7-6 6-6h28c3.3 0 6 2.7 6 6v28c0 3.3-2.7 6-6 6H18c-3.3 0-6-2.7-6-6V18Z" fill="rgba(37,99,235,.14)"/>
          <path d="M18 12h28a6 6 0 0 1 6 6v28a6 6 0 0 1-6 6H18a6 6 0 0 1-6-6V18a6 6 0 0 1 6-6Z" stroke="rgba(37,99,235,.75)" stroke-width="3"/>
          <path d="M22 22h20" stroke="rgba(17,24,39,.55)" stroke-width="3" stroke-linecap="round"/>
          <path d="M22 30h16" stroke="rgba(17,24,39,.38)" stroke-width="3" stroke-linecap="round"/>
          <path d="M22 38h12" stroke="rgba(17,24,39,.28)" stroke-width="3" stroke-linecap="round"/>
          <path d="M46 26h6" stroke="rgba(37,99,235,.85)" stroke-width="3" stroke-linecap="round"/>
        </svg>
        <div>
          <div class="brand-name">小账本</div>
          <div class="brand-sub">统计</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" onclick="location.href='/'">返回</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <div class="muted" style="margin-bottom:6px;">年份</div>
          <select id="year">
            {% for y in years %}
              <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}年</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <div class="muted" style="margin-bottom:6px;">月份</div>
          <select id="month">
            {% for m in months %}
              <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>{{ m }}月</option>
            {% endfor %}
          </select>
        </div>

        <button class="btn btn-primary" onclick="applyYM()">查看</button>

        <div class="muted" style="margin-left:auto;">
          {{ month_start }} 至 {{ month_end }}
        </div>
      </div>

      <div class="stats">
        <div class="stat"><div class="k">本月总支出</div><div class="v">¥ {{ "%.2f"|format(month_expense) }}</div></div>
        <div class="stat"><div class="k">本月总收入</div><div class="v">¥ {{ "%.2f"|format(month_income) }}</div></div>
        <div class="stat"><div class="k">本月结余</div><div class="v">¥ {{ "%.2f"|format(month_balance) }}</div></div>
      </div>

      <div class="section-title">按周</div>
      <div class="muted">周区间保持完整（周一到周日），金额只统计该周落在本月的部分。</div>

      <table>
        <tr>
          <th>周区间</th>
          <th>本月覆盖</th>
          <th>支出</th>
          <th>收入</th>
          <th>结余</th>
          <th>详情</th>
        </tr>
        {% for w in week_rows %}
        <tr>
          <td>{{ w.week_start }} ~ {{ w.week_end }}</td>
          <td><span class="pill">{{ w.in_month_start }} ~ {{ w.in_month_end }}</span></td>
          <td>¥ {{ "%.2f"|format(w.expense) }}</td>
          <td>¥ {{ "%.2f"|format(w.income) }}</td>
          <td>¥ {{ "%.2f"|format(w.balance) }}</td>
          <td>
            <button class="rowbtn"
              onclick="location.href='/stats?year={{ selected_year }}&month={{ selected_month }}&week_start={{ w.week_start }}'">
              查看
            </button>
          </td>
        </tr>
        {% endfor %}
      </table>

      {% if selected_week %}
        <div class="section-title">本周支出分类</div>
        <div class="muted" style="margin-top:-2px;">
          {{ selected_week.week_start }} ~ {{ selected_week.week_end }}
          （统计区间：{{ selected_week.in_month_start }} ~ {{ selected_week.in_month_end }}）
        </div>

        {% if by_category|length == 0 %}
          <div class="muted" style="margin-top:10px;">暂无支出</div>
        {% else %}
          <table>
            <tr><th>分类</th><th>支出</th></tr>
            {% for c, s in by_category %}
              <tr><td>{{ c }}</td><td>¥ {{ "%.2f"|format(s) }}</td></tr>
            {% endfor %}
          </table>
        {% endif %}
      {% endif %}
    </div>
  </div>

<script>
  function applyYM(){
    const y = document.getElementById('year').value;
    const m = document.getElementById('month').value;
    location.href = `/stats?year=${encodeURIComponent(y)}&month=${encodeURIComponent(m)}`;
  }
</script>
</body>
</html>

