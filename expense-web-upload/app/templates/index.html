<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>小账本</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280;
      --line:#e5e7eb; --primary:#2563eb; --primary2:#1d4ed8;
      --danger:#ef4444; --shadow:0 10px 25px rgba(17,24,39,.08); --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:"PingFang SC","Microsoft YaHei",Arial,sans-serif;color:var(--text);background:var(--bg);}
    .container{max-width:1100px;margin:24px auto;padding:0 16px;}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;background:var(--card);border:1px solid var(--line);
      border-radius:18px;box-shadow:var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:10px;}
    .brand-name{font-weight:800;letter-spacing:.3px;}
    .brand-sub{font-size:12px;color:var(--muted);margin-top:2px;}
    .actions{display:flex;gap:10px;align-items:center;}
    .btn{
      padding:10px 14px;border-radius:12px;border:1px solid rgba(37,99,235,.35);
      background:#fff;color:var(--primary2);font-weight:700;cursor:pointer;
    }
    .btn:hover{border-color:var(--primary2);}
    .btn-primary{background:var(--primary);border-color:var(--primary);color:#fff;}
    .btn-primary:hover{background:var(--primary2);border-color:var(--primary2);}

    .grid{display:grid;grid-template-columns:420px 1fr;gap:16px;align-items:start;margin-top:14px;}
    @media (max-width:980px){.grid{grid-template-columns:1fr;}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);padding:16px;}
    .err{background:#fff1f2;border:1px solid #fecdd3;color:#9f1239;padding:10px 12px;border-radius:12px;margin:14px 0;font-size:14px;}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;}
    input,select{
      width:100%;padding:10px 12px;border:1px solid var(--line);
      border-radius:12px;outline:none;background:#fff;font-size:14px;
    }
    input:focus,select:focus{border-color:rgba(37,99,235,.6);box-shadow:0 0 0 4px rgba(37,99,235,.12);}
    .form{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .full{grid-column:1 / -1;}

    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
    @media (max-width:520px){.stats{grid-template-columns:1fr;}}
    .stat{border:1px solid var(--line);border-radius:14px;padding:12px;background:#fafafa;}
    .stat .k{color:var(--muted);font-size:12px;}
    .stat .v{font-size:18px;margin-top:6px;font-weight:800;}

    table{width:100%;border-collapse:collapse;border-radius:16px;overflow:hidden;border:1px solid var(--line);background:#fff;margin-top:12px;}
    th,td{padding:10px;border-bottom:1px solid var(--line);font-size:14px;vertical-align:top;}
    th{background:#f9fafb;color:#374151;font-weight:800;font-size:13px;text-align:left;}
    tr:last-child td{border-bottom:none;}
    .tag{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#f9fafb;font-size:12px;color:#374151;font-weight:700;}
    .tag.expense{background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.25);color:#b91c1c;}
    .tag.income{background:rgba(16,185,129,.10);border-color:rgba(16,185,129,.25);color:#047857;}
    .btn-del{
      padding:8px 10px;border-radius:10px;border:1px solid rgba(239,68,68,.35);
      background:#fff;color:#b91c1c;cursor:pointer;font-weight:700;
    }
    .btn-del:hover{background:rgba(239,68,68,.08);}
    .empty{
      display:flex;gap:14px;align-items:center;padding:14px;border:1px dashed var(--line);
      border-radius:16px;background:#fafafa;color:var(--muted);
    }
    .empty svg{flex:0 0 auto}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <!-- Wallet/Notebook style SVG logo -->
        <svg width="34" height="34" viewBox="0 0 64 64" fill="none" aria-hidden="true">
          <path d="M12 18c0-3.3 2.7-6 6-6h28c3.3 0 6 2.7 6 6v28c0 3.3-2.7 6-6 6H18c-3.3 0-6-2.7-6-6V18Z" fill="rgba(37,99,235,.14)"/>
          <path d="M18 12h28a6 6 0 0 1 6 6v28a6 6 0 0 1-6 6H18a6 6 0 0 1-6-6V18a6 6 0 0 1 6-6Z" stroke="rgba(37,99,235,.75)" stroke-width="3"/>
          <path d="M22 22h20" stroke="rgba(17,24,39,.55)" stroke-width="3" stroke-linecap="round"/>
          <path d="M22 30h16" stroke="rgba(17,24,39,.38)" stroke-width="3" stroke-linecap="round"/>
          <path d="M22 38h12" stroke="rgba(17,24,39,.28)" stroke-width="3" stroke-linecap="round"/>
          <path d="M46 26h6" stroke="rgba(37,99,235,.85)" stroke-width="3" stroke-linecap="round"/>
        </svg>
        <div>
          <div class="brand-name">小账本</div>
          <div class="brand-sub">记一笔，就更清楚</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" type="button" onclick="location.href='/stats'">统计</button>
      </div>
    </div>

    {% if request.query_params.get("err") %}
      <div class="err">{{ request.query_params.get("err") }}</div>
    {% endif %}

    <div class="grid">
      <div class="card">
        <form action="/add" method="post" class="form">
          <div>
            <label>类型</label>
            <select id="type" name="r_type" required>
              <option value="expense" selected>支出</option>
              <option value="income">收入</option>
            </select>
          </div>

          <div>
            <label>金额</label>
            <input name="amount" type="text" placeholder="25.5" required />
          </div>

          <div>
            <label>分类</label>
            <select id="category" name="category" required></select>
          </div>

          <div>
            <label>日期</label>
            <input name="date_str" type="date" required />
          </div>

          <div class="full">
            <label>备注</label>
            <input name="note" type="text" maxlength="100" />
          </div>

          <div class="full">
            <button class="btn btn-primary" type="submit" style="width:100%;">保存</button>
          </div>
        </form>

        <script>
          // init date
          const dateInput = document.querySelector('input[name="date_str"]');
          if (dateInput && !dateInput.value) {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth()+1).padStart(2,'0');
            const dd = String(now.getDate()).padStart(2,'0');
            dateInput.value = `${yyyy}-${mm}-${dd}`;
          }

          const expenseCats = {{ expense_categories | tojson }};
          const incomeCats = {{ income_categories | tojson }};

          function renderCats(type){
            const sel = document.getElementById("category");
            sel.innerHTML = "";
            const arr = (type === "income") ? incomeCats : expenseCats;
            for (const c of arr){
              const opt = document.createElement("option");
              opt.value = c;
              opt.textContent = c;
              sel.appendChild(opt);
            }
          }

          const typeSel = document.getElementById("type");
          renderCats(typeSel.value);
          typeSel.addEventListener("change", () => renderCats(typeSel.value));
        </script>
      </div>

      <div class="card">
        <div class="stats">
          <div class="stat"><div class="k">总支出</div><div class="v">¥ {{ "%.2f"|format(total_expense) }}</div></div>
          <div class="stat"><div class="k">总收入</div><div class="v">¥ {{ "%.2f"|format(total_income) }}</div></div>
          <div class="stat"><div class="k">结余</div><div class="v">¥ {{ "%.2f"|format(balance) }}</div></div>
        </div>

        {% if by_category|length != 0 %}
          <table>
            <tr><th>分类</th><th>支出</th></tr>
            {% for c, s in by_category %}
              <tr><td>{{ c }}</td><td>¥ {{ "%.2f"|format(s) }}</td></tr>
            {% endfor %}
          </table>
        {% else %}
          <div class="empty" style="margin-top:12px;">
            <svg width="52" height="52" viewBox="0 0 64 64" fill="none" aria-hidden="true">
              <path d="M14 22c0-4 3-7 7-7h22c4 0 7 3 7 7v20c0 4-3 7-7 7H21c-4 0-7-3-7-7V22Z" fill="rgba(37,99,235,.10)"/>
              <path d="M22 29h20" stroke="rgba(17,24,39,.45)" stroke-width="3" stroke-linecap="round"/>
              <path d="M22 37h14" stroke="rgba(17,24,39,.28)" stroke-width="3" stroke-linecap="round"/>
              <path d="M18 18h28" stroke="rgba(37,99,235,.70)" stroke-width="3" stroke-linecap="round"/>
            </svg>
            <div>还没有支出记录，先记一笔吧。</div>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <table>
        <tr>
          <th>ID</th><th>日期</th><th>类型</th><th>分类</th><th>金额</th><th>备注</th><th>操作</th>
        </tr>
        {% for r in records %}
        <tr>
          <td>{{ r.id }}</td>
          <td>{{ r.date }}</td>
          <td>
            {% if r.type == "expense" %}
              <span class="tag expense">支出</span>
            {% else %}
              <span class="tag income">收入</span>
            {% endif %}
          </td>
          <td>{{ r.category }}</td>
          <td>¥ {{ "%.2f"|format(r.amount) }}</td>
          <td>{{ r.note or "" }}</td>
          <td>
            <form action="/delete/{{ r.id }}" method="post" onsubmit="return confirm('确认删除？');">
              <button class="btn-del" type="submit">删除</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </table>
    </div>
  </div>
</body>
</html>

